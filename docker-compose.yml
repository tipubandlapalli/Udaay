version: '3.8'

services:
  # Node.js Backend
  server:
    image: ${DOCKER_HUB_USERNAME:-rohitdeka}/lakecity-server:latest
    ports:
      - "80:8080"
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - PORT=8080
      - MONGO_URI=${MONGO_URI}
      - JWT_SECRET=${JWT_SECRET}
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
      - GOOGLE_CLOUD_PROJECT_ID=${GOOGLE_CLOUD_PROJECT_ID}
      - GOOGLE_CLOUD_BUCKET_NAME=${GOOGLE_CLOUD_BUCKET_NAME}
      - GOOGLE_CLOUD_KEY_FILE=/app/config/service-key.json
      - CLIENT_URL=${CLIENT_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - AI_BACKEND_URL=http://ai-backend:5000
      - INTERNAL_JWT_SECRET=${INTERNAL_JWT_SECRET}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_PRIVATE_KEY_ID=${FIREBASE_PRIVATE_KEY_ID}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - FIREBASE_CLIENT_ID=${FIREBASE_CLIENT_ID}
      - FIREBASE_CERT_URL=${FIREBASE_CERT_URL}
    volumes:
      - ./server/config:/app/config:ro
    depends_on:
      - ai-backend
    networks:
      - lakecity-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Spring Boot AI Backend
  ai-backend:
    image: ${DOCKER_HUB_USERNAME:-rohitdeka}/lakecity-ai-backend:latest
    ports:
      - "5000:5000"
    environment:
      - SERVER_PORT=5000
      - GEMINI_PROJECT_ID=${GEMINI_PROJECT_ID}
      - GEMINI_LOCATION=${GEMINI_LOCATION}
      - GEMINI_MODEL=${GEMINI_MODEL}
      - GEMINI_SERVICE_ACCOUNT_FILE=/app/config/service-account-key.json
      - INTERNAL_JWT_SECRET=${INTERNAL_JWT_SECRET}
    volumes:
      - ./ai_backend/config:/app/config:ro
    networks:
      - lakecity-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  lakecity-network:
    driver: bridge
